# SONiC+ HLD

## High Level Design Document

# Table of Contents

# List of Tables

# List of Figures

# About this Manual

This document provides an overview of the design of implementation of SONiC+

# Scope

This document describes the high level design of SONiC+ infrastructure

# Definitions/Abbreviation

# Overview

SONiC+ - a SONiC infrastructure for building and integrating third-party out-of-tree services/features that provide their functionality as a docker container managed as a systemd service.

# Requirements

- Extention provides its functionality as another docker container running alongside SONiC core services
- Extension is distributed as a docker image available though Docker Hub or private registry
- SONiC+ services is an extension to existing *feature* conecpt already available in SONiC, that means, a SONiC+ service is a subject to the same handlers as for *feature*s
- SONiC+ infrastructure provides a CLI interface to install, remove, list available SONiC+ extensions
- Installed SONiC+ extenstions migrate during SONiC-2-SONiC upgrades
- An extention is backward and forward compatible between SONiC releases

# Design

Besides of a docker image, there are the following parts of the host OS that are missing:

- systemd service
- initial configuration
- CLI sub-commands for *show*, *config*, *sonic-clear*, etc.

docker start script can be autogenerated from https://github.com/Azure/sonic-buildimage/blob/master/files/build_templates/docker_image_ctl.j2. Need to put docker_image_ctl.j2 into /usr/share/sonic/templates/.

## sonic-plus utility

```
sonic-plus addrepo [REPO] [NAME]
sonic-plus install [NAME]
sonic-plus remove [NAME]
```

Repo file is saved under /var/lib/sonic-plus/repo.json

The procedure of installing is:
- pull docker image 
- create a temporary container from the pulled image
- extract needed templates
- generate start script and put in /usr/bin/<feature>.sh
- copy systemd service file to /etc/sysetmd/system/<feature>.service
- register new feature in FEATURE table in CONFIG DB
- merge init_cfg.json into CONFIG DB
- save config

## Config DB schema file

For what-just-happeend:

```json
{
    "schema": {
      "name": "what-just-happened",
      "description": "what-just-happened",
      "tables": [
        {
          "name": "WJH",
          "description": "what-just-happened global configuration",
          "operations": [
              "show",
              "config"
          ],
          "predefined_keys": [
            {
              "name": "global"
            }
          ],
          "fields": [
            {
              "name": "nice_level",
              "pretty_name": "Nice Level",
              "description": "what-just-happened daemon nice level",
              "type": "intrange",
              "int_max": 19,
              "int_min": -20
            },
            {
              "name": "pci_bandwidth",
              "pretty_name": "PCI Bandwidth (%)",
              "description": "what-just-happened PCI bandwidth consumption threasold",
              "type": "intrange",
              "int_max": 0,
              "int_min": 100
            }
          ]
        },
        {
          "name": "WJH_CHANNEL",
          "subcommand_name": "channel",
          "description": "what-just-happened channels configuration",
          "operations": [
              "show",
              "config"
          ],
          "fields": [
            {
              "name": "channel_type",
              "pretty_name": "Channel Type",
              "description": "WJH channel type (raw/aggregated/direct_raw/aggregated_counter)",
              "type": "choice",
              "optional": false,
              "choice_list": [
                "raw",
                "aggregated",
                "direct_raw",
                "aggregated_counter"
              ]
            },
            {
              "name": "polling_interval",
              "pretty_name": "Polling interval (s)",
              "description": "Polling interval of this channel in seconds",
              "type": "int",
              "optional": true
            },
            {
              "name": "drop_category_list",
              "pretty_name": "Drop category list",
              "description": "Drop category list",
              "type": "string",
              "optional": false
            }
          ]
        }
      ],
      "additional_commands": [
        {
          "operations": [
              "show"
          ],
          "name": "pull",
          "show_default_command": true,
          "cmd": "/usr/bin/wjhcli",
          "args": [
            {
              "name": "channel",
              "type": "choice",
              "choice_from_config_db_table": "WJH_CHANNEL", 
              "description": "channel name"
            }
          ]
        }
      ]
    }
  }
```

Generates following files:

$PYTHONPATH/show/plugins/what-just-happened.py
$PYTHONPATH/config/plugins/what-just-happened.py

show and config should be extended to dynamically discover and load plugins in those directories.

```
show what-just-happened config global
config what-just-happened global nice-level [INT]
config what-just-happened global pci-bandwidth [INT]

show what-just-happened config channel
config what-just-happened config channel create|remove [CHANNEL_NAME] [TYPE] [DROP_CATEGORY_LIST] [--polling-interval]

show what-just-happened [CHANNEL_NAME]  (show what-just-happened pull [CHANNEL_NAME])
```

